<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8"/>
    <title>Pandemie Simulation</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        /* Allgemeines Design */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #FFF8DC; /* Helleres Beige (Cornsilk) */
            color: #2b2b2b;
        }
        h1, h2, h3 {
            margin-bottom: 5px;
        }
        p {
            margin-top: 0;
        }
        a {
            color: #001f3f;
        }

        /* Übergeordnete Container */
        #sliders {
            margin-bottom: 20px;
        }
        .category-section {
            display: flex;
            flex-wrap: wrap;       /* Erlaubt Umbruch */
            margin-bottom: 25px;
            background: rgba(255,255,255,0.4); /* Weniger hell */
            padding: 10px 15px;
            border-radius: 5px;
        }
        .category-section h3 {
            width: 100%;
            margin-bottom: 10px;
            color: #001f3f;
        }

        /* Einzelne Slider-Container */
        .slider-container {
            width: 45%;            /* Zwei Spalten, wenn genug Platz */
            min-width: 270px;      /* Damit es auf schmalen Bildschirmen nicht zu eng wird */
            margin-right: 5%;
            margin-bottom: 15px;
        }
        .slider-container label {
            display: block;
            font-weight: bold;
            margin-bottom: 3px;
            color: #001f3f;
        }
        .slider-description {
            margin-top: 0;
            margin-bottom: 8px;
            font-style: italic;
            color: #4e4e4e;
        }

        /* Slider-Styling */
        input[type="range"] {
            -webkit-appearance: none; 
            width: 100%;
            height: 6px;
            background: #b0c4de;   /* Helles Blau (light steel blue) für die Spur */
            outline: none;
            border-radius: 3px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #001f3f;   /* Navy-Blau */
            cursor: pointer;
            border: 1px solid #fff;
            box-shadow: 0 0 2px rgba(0,0,0,0.3);
        }
        input[type="range"]::-webkit-slider-thumb:hover {
            background: #002a5a;
        }

        /* Button-Styling */
        .custom-button {
            background-color: #001f3f; 
            color: #ffffff; 
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .custom-button:hover {
            background-color: #002a5a;
        }
        .custom-button:active {
            background-color: #000f2b;
            box-shadow: none;
        }

        /* Container für Button und Graph */
        #buttons-container {
            margin-top: 20px;
            margin-bottom: 20px;
        }
        #graph {
            margin-top: 20px;
            background: rgba(255,255,255,0.4); /* Gleiche Farbe wie Slider-Boxen */
            padding: 10px;
            border-radius: 5px;
        }

        /* Werte-Anzeige neben dem Slider */
        .slider-value {
            margin-left: 8px;
            font-weight: bold;
            color: #001f3f;
        }
    </style>
</head>
<body>

<h1>Pandemie Simulation</h1>
<p>
    Dieses Beispiel zeigt eine Simulation direkt im Browser 
    mit JavaScript und Plotly.
</p>

<div id="sliders">

    <!-- Populations-Parameter -->
    <div class="category-section">
        <h3>Populations-Parameter</h3>

        <!-- Anzahl der Blobs (logarithmisch per 2^ ) -->
        <div class="slider-container">
            <label for="blobsNumber">Anzahl der Blobs</label>
            <p class="slider-description">Gesamtanzahl der simulierten Blobs.</p>
            <!-- Exponent -> 2^exponent, z.B. exponent=7..14 -->
            <input type="range" id="blobsNumber" min="7" max="14" step="1" value="9">
            <span id="blobsNumberValue" class="slider-value">512</span>
        </div>

        <!-- Simulationsdauer (logarithmisch per 4^ ) -->
        <div class="slider-container">
            <label for="simulationDays">Simulationsdauer in Tagen</label>
            <p class="slider-description">Gesamtlänge der Simulation.</p>
            <!-- exponent -> 4^exponent, z.B. exponent=0..5 => 1..1024 -->
            <input type="range" id="simulationDays" min="0" max="5" step="0.1" value="3">
            <span id="simulationDaysValue" class="slider-value">64</span>
        </div>
    </div>

    <!-- Infektionsdynamik -->
    <div class="category-section">
        <h3>Infektionsdynamik</h3>

        <!-- Infektiosität (logarithmisch per 10^ ) -->
        <div class="slider-container">
            <label for="infectivity">Infektiosität</label>
            <p class="slider-description">Wahrscheinlichkeit, dass ein Infizierter pro Tag andere ansteckt.</p>
            <!-- exponent -> 10^exponent, exponent in [-4..-2], default about -2.3 => ~0.005 -->
            <input type="range" id="infectivity" min="-4" max="-2" step="0.1" value="-2.3">
            <span id="infectivityValue" class="slider-value">0.005</span>
        </div>

        <!-- Schweregrad -->
        <div class="slider-container">
            <label for="severity">Schweregrad</label>
            <p class="slider-description">Wahrscheinlichkeit, dass ein Infizierter ernsthaft erkrankt.</p>
            <input type="range" id="severity" min="0" max="1" value="0.15" step="0.01">
            <span id="severityValue" class="slider-value">0.15</span>
        </div>

        <!-- Genesungswahrscheinlichkeit -->
        <div class="slider-container">
            <label for="recoveryChance">Genesungswahrscheinlichkeit</label>
            <p class="slider-description">Wahrscheinlichkeit, dass ein Infizierter pro Tag genest.</p>
            <input type="range" id="recoveryChance" min="0" max="1" value="0.3" step="0.01">
            <span id="recoveryChanceValue" class="slider-value">0.3</span>
        </div>

        <!-- Halbwertszeit der Immunität (logarithmisch per 5^ ) -->
        <div class="slider-container">
            <label for="immunityHalfTime">Halbwertszeit der Immunität</label>
            <p class="slider-description">Anzahl Tage, nach denen die Immunität auf die Hälfte sinkt.</p>
            <!-- exponent -> 5^exponent, exponent in [-1..3], default=0 => 5^0=1 -->
            <input type="range" id="immunityHalfTime" min="-1" max="3" step="0.1" value="0">
            <span id="immunityHalfTimeValue" class="slider-value">1</span>
        </div>

        <!-- Anteil bereits Infizierter -->
        <div class="slider-container">
            <label for="infectedFromStart">Anteil bereits Infizierter</label>
            <p class="slider-description">Prozentsatz, der von Anfang an infiziert ist.</p>
            <input type="range" id="infectedFromStart" min="0" max="1" value="0.05" step="0.01">
            <span id="infectedFromStartValue" class="slider-value">0.05</span>
        </div>
    </div>

    <!-- Strategie-Parameter -->
    <div class="category-section">
        <h3>Strategie-Parameter</h3>

        <!-- Anteil Strategie 1 -->
        <div class="slider-container">
            <label for="strategy1Size">Anteil Strategie 1</label>
            <p class="slider-description">Prozentualer Anteil der Population, der Strategie 1 folgt.</p>
            <input type="range" id="strategy1Size" min="0" max="1" value="0.5" step="0.01">
            <span id="strategy1SizeValue" class="slider-value">0.5</span>
        </div>

        <!-- Kapazität Gesundheitssystem (logarithmisch per 2^ ) -->
        <div class="slider-container">
            <label for="healthcareSize">Kapazität Gesundheitssystem</label>
            <p class="slider-description">Maximale Anzahl an Krankenhausbetten.</p>
            <!-- exponent -> 2^exponent, exponent in [0..14], default=7 => 128 -->
            <input type="range" id="healthcareSize" min="0" max="14" step="1" value="7">
            <span id="healthcareSizeValue" class="slider-value">128</span>
        </div>

        <!-- Dynamikfaktor (Alpha) -->
        <div class="slider-container">
            <label for="alpha">Dynamikfaktor (Alpha)</label>
            <p class="slider-description">Beeinflusst die Ansteckungsrate bei Strategie 2.</p>
            <input type="range" id="alpha" min="0.1" max="2" value="0.5" step="0.1">
            <span id="alphaValue" class="slider-value">0.5</span>
        </div>
    </div>

    <!-- Fitness-Parameter -->
    <div class="category-section">
        <h3>Fitness-Parameter</h3>

        <!-- Verlust gesund -->
        <div class="slider-container">
            <label for="healthyFitnessLoss">Verlust gesund</label>
            <p class="slider-description">Fitnessverlust für gesunde Blobs.</p>
            <input type="range" id="healthyFitnessLoss" min="0" max="100" value="1" step="1">
            <span id="healthyFitnessLossValue" class="slider-value">1</span>
        </div>

        <!-- Verlust infiziert -->
        <div class="slider-container">
            <label for="infectedFitnessLoss">Verlust infiziert</label>
            <p class="slider-description">Fitnessverlust für asymptomatisch Infizierte.</p>
            <input type="range" id="infectedFitnessLoss" min="0" max="100" value="30" step="1">
            <span id="infectedFitnessLossValue" class="slider-value">30</span>
        </div>

        <!-- Verlust hospitalisiert -->
        <div class="slider-container">
            <label for="hospitalizedFitnessLoss">Verlust hospitalisiert</label>
            <p class="slider-description">Fitnessverlust für hospitalisierte Blobs.</p>
            <input type="range" id="hospitalizedFitnessLoss" min="0" max="100" value="20" step="1">
            <span id="hospitalizedFitnessLossValue" class="slider-value">20</span>
        </div>

        <!-- Verlust ernsthaft erkrankt -->
        <div class="slider-container">
            <label for="symptomsFitnessLoss">Verlust ernsthaft erkrankt</label>
            <p class="slider-description">Fitnessverlust für ernsthaft erkrankte Blobs.</p>
            <input type="range" id="symptomsFitnessLoss" min="0" max="100" value="60" step="1">
            <span id="symptomsFitnessLossValue" class="slider-value">60</span>
        </div>

        <!-- Gesamtfitness pro Tag (logarithmisch per 2^ ) -->
        <div class="slider-container">
            <label for="fitnessPerDay">Gesamtfitness pro Tag</label>
            <p class="slider-description">Maximale Fitness, die pro Tag verfügbar ist.</p>
            <!-- exponent -> 2^exponent, exponent in [0..15], default=10 => 1024 -->
            <input type="range" id="fitnessPerDay" min="0" max="15" step="1" value="10">
            <span id="fitnessPerDayValue" class="slider-value">1024</span>
        </div>
    </div>

</div>

<div id="buttons-container">
    <button class="custom-button" onclick="runSimulation()">Simulation starten</button>
</div>

<div id="graph"></div>

<script>
/* Hardcodierter Zeitschritt */
const time_step = 0.05;

/* Utility: prüft, ob ein Array komplett aus Nullen besteht */
function allZero(arr) {
    for (let i=0; i<arr.length; i++) {
        if (Math.abs(arr[i]) > 1e-12) {
            return false;
        }
    }
    return true;
}

/* Liest den Wert eines Sliders als Float aus. */
function getSliderFloatValue(id) {
    return parseFloat(document.getElementById(id).value);
}

/*
    Aktualisiert den angezeigten Wert eines Sliders.
    Wir konvertieren je nach Slider exponentiell.
*/
function attachSliderListener(sliderId, displayId, transformFunc) {
    const slider = document.getElementById(sliderId);
    const displayElem = document.getElementById(displayId);

    slider.oninput = function() {
        let val = parseFloat(this.value);
        displayElem.innerText = transformFunc ? transformFunc(val) : val;
    };
}

/* Konvertiert exponent in 2^exponent */
function twoPower(ex) {
    return Math.round(Math.pow(2, ex));
}
/* Konvertiert exponent in 4^exponent */
function fourPower(ex) {
    return Math.round(Math.pow(4, ex));
}
/* Konvertiert exponent in 10^exponent, gerundet auf z.B. 1e6? Besser float. */
function tenPower(ex) {
    let val = Math.pow(10, ex);
    // Runden z.B. auf 4 sign. digits
    return parseFloat(val.toPrecision(4));
}
/* Konvertiert exponent in 5^exponent als float, gerundet. */
function fivePower(ex) {
    let val = Math.pow(5, ex);
    return parseFloat(val.toPrecision(4));
}

/* Startet die Simulation und plottet das Ergebnis. */
function runSimulation() {

    // 1) Populations-Parameter
    let exponent_blobs = getSliderFloatValue("blobsNumber");
    let blobs_number = twoPower(exponent_blobs);

    let exponent_days = getSliderFloatValue("simulationDays");
    let simulation_days = fourPower(exponent_days);

    // 2) Strategie-Parameter
    let strategy_1_size = getSliderFloatValue("strategy1Size");

    let exponent_healthcare = getSliderFloatValue("healthcareSize");
    let Healthcare_size = twoPower(exponent_healthcare);

    let alpha = getSliderFloatValue("alpha");

    // 3) Infektionsdynamik
    let exponent_infectivity = getSliderFloatValue("infectivity");
    let infectivity = Math.pow(10, exponent_infectivity);

    let severity = getSliderFloatValue("severity");
    let recovery_chance = getSliderFloatValue("recoveryChance");

    let exponent_immunity = getSliderFloatValue("immunityHalfTime");
    let immunity_half_time = fivePower(exponent_immunity);

    let Infected_from_start = getSliderFloatValue("infectedFromStart");

    // 4) Fitness-Parameter
    let healthy_fitness_loss = getSliderFloatValue("healthyFitnessLoss");
    let infected_fitness_loss = getSliderFloatValue("infectedFitnessLoss");
    let hospitalized_fitness_loss = getSliderFloatValue("hospitalizedFitnessLoss");
    let symptoms_fitness_loss = getSliderFloatValue("symptomsFitnessLoss");

    let exponent_fitness = getSliderFloatValue("fitnessPerDay");
    let fitness_per_day = twoPower(exponent_fitness);

    // Schritte pro Tag
    let steps_per_day = Math.round(1.0 / time_step);

    // Abgeleitete Werte (analog zum Python-Modell)
    let mu_S = healthy_fitness_loss / 100.0;
    let mu_I = symptoms_fitness_loss / 100.0;
    let mu_A = infected_fitness_loss / 100.0;
    let mu_H = hospitalized_fitness_loss / 100.0;
    let mu_R = healthy_fitness_loss / 100.0;
    let epsilon = Math.log(2) / immunity_half_time;
    let gamma = recovery_chance;
    let beta = infectivity;

    // Startpopulationen (Strategie 1)
    let S1 = blobs_number * strategy_1_size * (1 - Infected_from_start);
    let I1 = blobs_number * strategy_1_size * Infected_from_start * severity;
    let A1 = blobs_number * strategy_1_size * Infected_from_start * (1 - severity);
    let H1 = 0;
    let R1 = 0;

    // Startpopulationen (Strategie 2)
    let S2 = blobs_number * (1 - strategy_1_size) * (1 - Infected_from_start);
    let I2 = blobs_number * (1 - strategy_1_size) * Infected_from_start * severity;
    let A2 = blobs_number * (1 - strategy_1_size) * Infected_from_start * (1 - severity);
    let H2 = 0;
    let R2 = 0;

    // Zeitreihen-Arrays
    let S1_list = [S1], I1_list = [I1], H1_list = [H1], A1_list = [A1], R1_list = [R1];
    let S2_list = [S2], I2_list = [I2], H2_list = [H2], A2_list = [A2], R2_list = [R2];

    // Simulation
    for(let day = 0; day < simulation_days; day++){
        for(let step = 0; step < steps_per_day; step++){
            let total_population = S1 + I1 + R1 + S2 + I2 + R2 + A1 + A2 + H1 + H2;
            let total_infected = I1 + I2 + H1 + H2 + A1 + A2;

            // Strategy 1 Koeffizienten
            let xi_S1 = Math.max(0, (fitness_per_day - healthy_fitness_loss) / (100.0 * total_population));
            let xi_A1 = Math.max(0, (fitness_per_day - infected_fitness_loss) / (100.0 * total_population));
            let xi_R1 = Math.max(0, (fitness_per_day - healthy_fitness_loss) / (100.0 * total_population));

            // Strategy 2 Koeffizienten
            let xi_S2 = xi_S1 * (1 - total_infected / total_population);
            let xi_A2 = xi_A1 * (1 - total_infected / total_population);
            let xi_R2 = xi_R1 * (1 - total_infected / total_population);

            // Angepasstes beta für Strategie 2
            let beta2 = beta * Math.pow(2, - (total_infected / (total_population * alpha)));

            // Gemeinsame Hospitalisierung
            let combined_H = H1 + H2;

            // Strategie 1 - Ableitungen
            let dS1 = (epsilon * R1 + xi_S1 * S1 + xi_A1 * A1 + xi_R1 * R1
                       - beta * (A1 + A2) * S1 - mu_S * S1) * time_step;
            let dI1 = 0, dH1 = 0, dA1 = 0, dR1 = 0;

            if (combined_H <= Healthcare_size) {
                dI1 = (-gamma * I1 - mu_I * I1) * time_step;
                dH1 = (beta * severity * (A1 + A2) * S1 - gamma * H1 - mu_H * H1) * time_step;
            } else {
                dI1 = (beta * severity * (A1 + A2) * S1 - gamma * I1 - mu_I * I1) * time_step;
                dH1 = (-gamma * H1 - mu_H * H1) * time_step;
            }

            dA1 = (beta * (1 - severity) * (A1 + A2) * S1 - gamma * A1 - mu_A * A1) * time_step;
            dR1 = (gamma * I1 + gamma * A1 - epsilon * R1 - mu_R * R1) * time_step;

            // Strategie 2 - Ableitungen
            let dS2 = (epsilon * R2 + xi_S2 * S2 + xi_A2 * A2 + xi_R2 * R2
                       - beta2 * (A1 + A2) * S2 - mu_S * S2) * time_step;
            let dI2 = 0, dH2 = 0, dA2 = 0, dR2 = 0;

            if (combined_H <= Healthcare_size) {
                dI2 = (-gamma * I2 - mu_I * I2) * time_step;
                dH2 = (beta2 * severity * (A1 + A2) * S2 - gamma * H2 - mu_H * H2) * time_step;
            } else {
                dI2 = (beta2 * severity * (A1 + A2) * S2 - gamma * I2 - mu_I * I2) * time_step;
                dH2 = (-gamma * H2 - mu_H * H2) * time_step;
            }

            dA2 = (beta2 * (1 - severity) * (A1 + A2) * S2 - gamma * A2 - mu_A * A2) * time_step;
            dR2 = (gamma * I2 + gamma * A2 - epsilon * R2 - mu_R * R2) * time_step;

            // Update Strategie 1
            S1 += dS1; I1 += dI1; H1 += dH1; A1 += dA1; R1 += dR1;

            // Update Strategie 2
            S2 += dS2; I2 += dI2; H2 += dH2; A2 += dA2; R2 += dR2;
        }

        // Werte speichern (nach jedem Tag)
        S1_list.push(S1); I1_list.push(I1); H1_list.push(H1); A1_list.push(A1); R1_list.push(R1);
        S2_list.push(S2); I2_list.push(I2); H2_list.push(H2); A2_list.push(A2); R2_list.push(R2);
    }

    // Tage-Array
    let days = Array.from({length: simulation_days + 1}, (_, i) => i);

    // Funktionsnamen:
    // S -> "Infizierbar"
    // I -> "ernsthaft infiziert"
    // H -> "hospitalisiert"
    // A -> "symptomlos"
    // R -> "immun"

    // Erstellen wir Helper-Funktion, um je nach Array die Trace hinzuzufügen
    function makeTrace(xArray, yArray, name, color, dash) {
        return {
            x: xArray,
            y: yArray,
            type: 'scatter',
            mode: 'lines',
            name: name,
            line: { color: color, dash: dash }
        };
    }

    let data = [];

    // Falls S1 oder S2 nicht alle Null => trace
    if (!allZero(S1_list)) data.push( makeTrace(days, S1_list, "Infizierbar", 'navy', 'solid') );
    if (!allZero(S2_list)) data.push( makeTrace(days, S2_list, "Infizierbar", 'blue', 'dash') );

    if (!allZero(I1_list)) data.push( makeTrace(days, I1_list, "ernsthaft infiziert", 'darkred', 'solid') );
    if (!allZero(I2_list)) data.push( makeTrace(days, I2_list, "ernsthaft infiziert", 'red', 'dash') );

    if (!allZero(H1_list)) data.push( makeTrace(days, H1_list, "hospitalisiert", 'darkgreen', 'solid') );
    if (!allZero(H2_list)) data.push( makeTrace(days, H2_list, "hospitalisiert", 'green', 'dash') );

    if (!allZero(A1_list)) data.push( makeTrace(days, A1_list, "symptomlos", 'orange', 'solid') );
    if (!allZero(A2_list)) data.push( makeTrace(days, A2_list, "symptomlos", 'goldenrod', 'dash') );

    if (!allZero(R1_list)) data.push( makeTrace(days, R1_list, "immun", 'purple', 'solid') );
    if (!allZero(R2_list)) data.push( makeTrace(days, R2_list, "immun", 'indigo', 'dash') );

    let layout = {
        title: 'Pandemie Simulation',
        xaxis: { title: 'Tage' },
        yaxis: { title: 'Population' },
        paper_bgcolor: 'rgba(255,255,255,0.4)',
        plot_bgcolor: 'rgba(255,255,255,0.4)',
        hovermode: 'closest'  /* Nur Wert des nächsten Punktes */
    };
    let config = {
        displayModeBar: false  /* Keine Toolbar */
    };

    Plotly.newPlot('graph', data, layout, config);
}

/* Slider-Listener aktivieren */
// blobsNumber -> 2^exponent
attachSliderListener("blobsNumber", "blobsNumberValue", val => {
    return twoPower(val);
});

// simulationDays -> 4^exponent
attachSliderListener("simulationDays", "simulationDaysValue", val => {
    return fourPower(val);
});

// infectivity -> 10^exponent
attachSliderListener("infectivity", "infectivityValue", val => {
    let v = Math.pow(10, val);
    return parseFloat(v.toPrecision(4));
});

// immunityHalfTime -> 5^exponent
attachSliderListener("immunityHalfTime", "immunityHalfTimeValue", val => {
    let v = Math.pow(5, val);
    return parseFloat(v.toPrecision(4));
});

// healthcareSize -> 2^exponent
attachSliderListener("healthcareSize", "healthcareSizeValue", val => {
    return twoPower(val);
});

// fitnessPerDay -> 2^exponent
attachSliderListener("fitnessPerDay", "fitnessPerDayValue", val => {
    return twoPower(val);
});

// Die übrigen Slider linear
["severity","recoveryChance","infectedFromStart","strategy1Size",
 "healthyFitnessLoss","infectedFitnessLoss","hospitalizedFitnessLoss","symptomsFitnessLoss"]
.forEach(id => {
    attachSliderListener(id, id + "Value");
});

</script>

</body>
</html>